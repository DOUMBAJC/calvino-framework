#!/usr/bin/env php
<?php
// ░█▀▀█ ─█▀▀█ ░█─── ░█──░█ ▀█▀ ░█▄─░█ ░█▀▀▀█ 
// ░█─── ░█▄▄█ ░█─── ─░█░█─ ░█─ ░█░█░█ ░█──░█ 
// ░█▄▄█ ░█─░█ ░█▄▄█ ──▀▄▀─ ▄█▄ ░█──▀█ ░█▄▄▄█

/**
 * Calvino Framework CLI
 * Point d'entrée pour les commandes en ligne de commande
 */

// Autoloading
if (file_exists(__DIR__ . '/../vendor/autoload.php')) {
    // Cas où on exécute depuis bin/calvino
    require __DIR__ . '/../vendor/autoload.php';
    if (!defined('BASE_PATH')) {
        define('BASE_PATH', dirname(__DIR__));
    }
} elseif (file_exists(__DIR__ . '/../../../autoload.php')) {
    // Cas où le framework est installé comme dépendance dans vendor/
    require __DIR__ . '/../../../autoload.php';
    if (!defined('BASE_PATH')) {
        define('BASE_PATH', dirname(dirname(dirname(__DIR__))));
    }
    // Si on est dans vendor, le dossier vendor est root/vendor
} else {
    fwrite(STDERR, "Erreur : Autoloader non trouvé. Veuillez exécuter 'composer install'.\n");
    exit(1);
}

// Définir les variables d'environnement pour simuler une requête HTTP
$_SERVER['REQUEST_METHOD'] = 'CLI';
$_SERVER['REQUEST_URI'] = '/cli';

// Charger les variables d'environnement si elles existent
if (file_exists(BASE_PATH . '/.env')) {
    (new \Calvino\Core\Env())->load(BASE_PATH . '/.env');
}

// Charger la configuration si elle existe
if (file_exists(BASE_PATH . '/config/app.php')) {
    require_once BASE_PATH . '/config/app.php';
}

// Charger le bootstrap de l'application si il existe
if (file_exists(BASE_PATH . '/bootstrap/app.php')) {
    require_once BASE_PATH . '/bootstrap/app.php';
}

// Récupérer l'instance de l'application
$app = \Calvino\Core\Application::getInstance();

// Récupérer la commande et les arguments
$command = $argv[1] ?? 'help';
$args = array_slice($argv, 2);

// Créer le gestionnaire de commandes
$commandsHandler = new \Calvino\Console\CommandsHandler($app);

// Exécuter la commande demandée
$commandsHandler->execute($command, $args);