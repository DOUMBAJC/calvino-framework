#!/usr/bin/env php
<?php
// ░█▀▀█ ─█▀▀█ ░█─── ░█──░█ ▀█▀ ░█▄─░█ ░█▀▀▀█ 
// ░█─── ░█▄▄█ ░█─── ─░█░█─ ░█─ ░█░█░█ ░█──░█ 
// ░█▄▄█ ░█─░█ ░█▄▄█ ──▀▄▀─ ▄█▄ ░█──▀█ ░█▄▄▄█

/**
 * Calvino Framework CLI
 * Point d'entrée pour les commandes en ligne de commande
 */

// Autoloading
$autoloadPaths = [
    $GLOBALS['_composer_autoload_path'] ?? null,     // Priority: Composer defined path
    getcwd() . '/vendor/autoload.php',             // Current directory (most likely skeleton)
    __DIR__ . '/../../../autoload.php',            // Normal vendor installation
    __DIR__ . '/../vendor/autoload.php',           // Local framework development
];

$found = false;
foreach ($autoloadPaths as $path) {
    if ($path && file_exists($path)) {
        require $path;
        $found = true;
        
        // Define BASE_PATH if not defined
        if (!defined('BASE_PATH')) {
            // Path leads to root/vendor/autoload.php
            define('BASE_PATH', dirname(realpath($path), 2));
        }
        break;
    }
}

if (!$found) {
    fwrite(STDERR, "Erreur : Autoloader non trouvé. Veuillez exécuter 'composer install'.\n");
    exit(1);
}

// Définir les variables d'environnement pour simuler une requête HTTP
$_SERVER['REQUEST_METHOD'] = 'CLI';
$_SERVER['REQUEST_URI'] = '/cli';

// Charger les variables d'environnement si elles existent
if (file_exists(BASE_PATH . '/.env')) {
    (new \Calvino\Core\Env())->load(BASE_PATH . '/.env');
}

// Charger la configuration si elle existe
if (file_exists(BASE_PATH . '/config/app.php')) {
    require_once BASE_PATH . '/config/app.php';
}

// Charger le bootstrap de l'application si il existe
if (file_exists(BASE_PATH . '/bootstrap/app.php')) {
    require_once BASE_PATH . '/bootstrap/app.php';
}

// Récupérer l'instance de l'application
$app = \Calvino\Core\Application::getInstance();

// Récupérer la commande et les arguments
$command = $argv[1] ?? 'help';
$args = array_slice($argv, 2);

// Créer le gestionnaire de commandes
$commandsHandler = new \Calvino\Console\CommandsHandler($app);

// Exécuter la commande demandée
$commandsHandler->execute($command, $args);